#!/bin/bash

orchestrator_api="http://localhost:3000"

command=
instance=
destination=
alias=

instance_hostport=
destination_hostport=
default_port=3306

api_response=
api_details=

# Transform long options to short ones
for arg in "$@"; do
  shift
  case "$arg" in
    "--help")    set -- "$@" "-h" ;;
    "--command") set -- "$@" "-c" ;;
    "--alias")   set -- "$@" "-a" ;;
    "--orchestrator-api")   set -- "$@" "-U" ;;
    *)           set -- "$@" "$arg"
  esac
done

while getopts "c:i:d:s:a:D:U:" OPTION
do
  case $OPTION in
    c) command=$OPTARG ;;
    i) instance=$OPTARG ;;
    d) destination=$OPTARG ;;
    s) destination=$OPTARG ;;
    a) alias=$OPTARG ;;
    D) default_port=$OPTARG ;;
    U) orchestrator_api=$OPTARG ;;
  esac
done

function fail() {
  message="$1"
  echo "$message"
  exit 1
}

function check_requirements() {
  which -s curl || fail "cannot find curl"
  which -s jq   || fail "cannot find jq"
}

function assert_nonempty() {
  name="$1"
  value="$2"

  if [ -z "$value" ] ; then
    fail "$name must be provided"
  fi
}

# to_hostport transforms:
# - fqdn:port => fqdn/port
# - fqdn => fqdn/default_port
function to_hostport {
  instance_key="$1"

  if [ -z "$instance_key" ] ; then
    echo ""
    return
  fi

  if [[ $instance_key == *":"* ]]; then
    echo $instance_key | tr ':' '/'
  else
    echo "$instance_key/$default_port"
  fi
}

function normalize_orchestrator_api() {
  if [[ ! $orchestrator_api == *"/api" ]]; then
    orchestrator_api=${orchestrator_api%/}
    orchestrator_api="$orchestrator_api/api"
  fi
}

function api() {
  path="$1"

  normalize_orchestrator_api
  uri="$orchestrator_api/$path"
  # echo $uri
  api_response=$(curl -s $uri | jq '.')
  if [ "$(echo $api_response | jq -r 'type')" == "array" ] ; then
    return
  fi
  if [ "$(echo $api_response | jq -r 'has("Code")')" == "false" ] ; then
    return
  fi
  api_details=$(echo $api_response | jq '.Details')
  if echo $api_response | jq -r '.Code' | grep -q "ERROR" ; then
    echo $api_response | jq -r '.Message' | xargs >&2 echo
    [ "$api_details" != "null" ] && echo $api_details
    exit 1
  fi
}

function print_response {
  echo $api_response
}

function print_details {
  echo $api_details
}

function filter_key {
  cat - | jq '.Key'
}

function filter_master_key {
  cat - | jq '.MasterKey'
}

function filter_keys {
  cat - | jq '.[] | .Key'
}

function print_key {
  cat - | jq -r '. | (.Hostname + ":" + (.Port | tostring))'
}

function discover() {
  assert_nonempty "instance" "$instance_hostport"
  api "discover/$instance_hostport"
  print_details | filter_key | print_key
}

function instance() {
  assert_nonempty "instance" "$instance_hostport"
  api "instance/$instance_hostport"
  print_response | filter_key | print_key
}

function which_master() {
  assert_nonempty "instance" "$instance_hostport"
  api "instance/$instance_hostport"
  print_response | filter_master_key | print_key
}

function which_replicas() {
  assert_nonempty "instance" "$instance_hostport"
  api "instance-replicas/$instance_hostport"
  print_response | filter_keys | print_key
}

function which_cluster() {
  assert_nonempty "instance|alias" "${alias:-$instance}"
  api "cluster-info/${alias:-$instance}"
  print_response | jq -r '.ClusterName'
}

function which_cluster_instances() {
  assert_nonempty "instance|alias" "${alias:-$instance}"
  api "cluster/${alias:-$instance}"
  print_response | filter_keys | print_key
}

function all_clusters_masters() {
  api "masters"
  print_response | filter_keys | print_key
}

function forget() {
  assert_nonempty "instance" "$instance_hostport"
  api "forget/$instance_hostport"
}

function end_downtime() {
  assert_nonempty "instance" "$instance_hostport"
  api "end-downtime/$instance_hostport"
  print_details | print_key
}

function relocate() {
  assert_nonempty "instance" "$instance_hostport"
  assert_nonempty "destination" "$destination_hostport"
  api "relocate/$instance_hostport/$destination_hostport"
  echo "$(print_details | filter_key | print_key)<$(print_details | filter_master_key | print_key)"
}

function relocate_replicas() {
  assert_nonempty "instance" $instance_hostport
  assert_nonempty "destination" $destination_hostport
  api "relocate-replicas/$instance_hostport/$destination_hostport"
  print_details | filter_keys | print_key
}

function general_instance_command() {
  path="${1:-$command}"

  assert_nonempty "instance" "$instance_hostport"
  api "$path/$instance_hostport"
  print_details | filter_key | print_key
}


function run_command() {
  if [ -z "$command" ] ; then
    fail "No command given. Use -c or --command"
  fi
  case $command in
    "discover") discover ;;
    "forget") forget ;;
    "instance") instance ;;
    "which-master") which_master ;;
    "which-replicas") which_replicas ;;
    "which-cluster-instances") which_cluster_instances ;;
    "which-cluster") which_cluster ;;
    "all-clusters-masters") all_clusters_masters ;;
    "end-downtime") end_downtime ;;
    "relocate") relocate ;;
    "relocate-replicas") relocate_replicas ;;
    "stop-slave") general_instance_command ;;
    "stop-slave-nice") general_instance_command ;;
    "start-slave") general_instance_command ;;
    "restart-slave") general_instance_command ;;
    "reset-slave") general_instance_command ;;
    "detach-replica") general_instance_command ;;
    "reattach-replica") general_instance_command ;;
    "reattach-replica-master-host") general_instance_command ;;
    "skip-query") general_instance_command ;;
    "set-read-only") general_instance_command ;;
    "set-writeable") general_instance_command ;;
    "flush-binary-logs") general_instance_command ;;
    *) fail "Unsupported command $command" ;;
  esac
}

function main() {
  check_requirements

  instance_hostport=$(to_hostport $instance)
  destination_hostport=$(to_hostport $destination)

  run_command
}

main
