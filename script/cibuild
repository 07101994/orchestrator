#!/bin/bash

set -e

. script/bootstrap

echo "# Validating documentation"
echo "## docs/toc.md and docs/README.md must be identical"
diff docs/toc.md docs/README.md > /dev/null 2> /dev/null

ls docs/*.md | grep -v README.md | while read f ; do
  docfile="$(basename $f)"
  echo "## Checking if doc file $docfile is linked from another doc"
  egrep -c -R "[(]$docfile[)]" docs/ -q && echo "## - yes" || exit 1
done

echo "# Verifying code is formatted via 'gofmt -s -w  go/'"
gofmt -s -w  go/
git diff --exit-code --quiet

echo "# Building"
script/build

cd .gopath/src/github.com/github/orchestrator

echo "# Running unit tests"
go test ./go/...

echo "# Running integration tests"
./tests/integration/test.sh

echo "# Done"
